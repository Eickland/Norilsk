{% extends "base.html" %}

{% block title %}Управление версиями{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-history"></i> Управление версиями</h1>
            <p class="text-muted">Всего сохранено версий: {{ total_versions }}</p>
        </div>
        <div class="col-auto">
            <a href="/" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Назад к пробам
            </a>
            <button id="createVersionBtn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Создать версию
            </button>
        </div>
    </div>

    <!-- Фильтры -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="filterAuthor" class="form-label">Автор:</label>
                    <select id="filterAuthor" class="form-select">
                        <option value="">Все авторы</option>
                        <option value="system">Система</option>
                        <option value="user">Пользователь</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="filterType" class="form-label">Тип изменения:</label>
                    <select id="filterType" class="form-select">
                        <option value="">Все типы</option>
                        <option value="manual">Ручное</option>
                        <option value="auto">Автоматическое</option>
                        <option value="import">Импорт</option>
                        <option value="restore">Восстановление</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="filterDate" class="form-label">Дата:</label>
                    <input type="date" id="filterDate" class="form-control">
                </div>
            </div>
        </div>
    </div>

    <!-- Таблица версий -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">История версий</h5>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoRefresh">
                <label class="form-check-label" for="autoRefresh">Автообновление</label>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="versionsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Дата и время</th>
                            <th>Описание</th>
                            <th>Автор</th>
                            <th>Тип</th>
                            <th>Проб</th>
                            <th>Размер</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="versionsList">
                        <!-- Данные загружаются через JavaScript -->
                        <tr id="loadingRow">
                            <td colspan="8" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Загрузка...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Модальное окно сравнения версий -->
    <div class="modal fade" id="compareModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Сравнение версий</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="compareVersion1" class="form-label">Версия 1:</label>
                            <select id="compareVersion1" class="form-select"></select>
                        </div>
                        <div class="col-md-6">
                            <label for="compareVersion2" class="form-label">Версия 2:</label>
                            <select id="compareVersion2" class="form-select"></select>
                        </div>
                    </div>
                    <div id="comparisonResult"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-primary" id="doCompareBtn">Сравнить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно просмотра версии -->
    <div class="modal fade" id="viewVersionModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewVersionTitle">Просмотр версии</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>ID:</strong> <span id="viewVersionId"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Дата:</strong> <span id="viewVersionDate"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Автор:</strong> <span id="viewVersionAuthor"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Тип:</strong> <span id="viewVersionType"></span>
                        </div>
                        <div class="col-12">
                            <strong>Описание:</strong> <span id="viewVersionDescription"></span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <button class="btn btn-sm btn-outline-primary" id="toggleJsonView">
                            Показать/скрыть JSON
                        </button>
                    </div>
                    <div id="versionJsonView" style="display: none;">
                        <pre id="versionJsonContent" class="bg-light p-3 rounded" style="max-height: 400px; overflow: auto;"></pre>
                    </div>
                    <div id="versionPreview">
                        <h6>Предпросмотр данных:</h6>
                        <div id="versionPreviewContent"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-success" id="restoreVersionBtn">
                        <i class="fas fa-undo"></i> Восстановить эту версию
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="exportVersionBtn">
                        <i class="fas fa-download"></i> Экспорт
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно создания версии -->
    <div class="modal fade" id="createVersionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Создание новой версии</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="versionDescription" class="form-label">Описание изменений:</label>
                        <textarea class="form-control" id="versionDescription" rows="3" 
                                  placeholder="Опишите, какие изменения были внесены..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="versionAuthor" class="form-label">Автор:</label>
                        <input type="text" class="form-control" id="versionAuthor" 
                               value="Пользователь">
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Версия будет создана только если есть изменения с последней версии.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="confirmCreateVersionBtn">
                        Создать версию
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentSelectedVersion = null;
    let versions = [];
    
    // Загрузка версий
    function loadVersions() {
        fetch('/api/versions')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    versions = data.versions.reverse(); // Последние версии первыми
                    renderVersionsTable(versions);
                    updateCompareSelects(versions);
                }
            })
            .catch(error => {
                console.error('Error loading versions:', error);
                showError('Ошибка загрузки версий');
            });
    }
    
    // Отображение таблицы версий
    function renderVersionsTable(versionsList) {
        const tbody = document.getElementById('versionsList');
        
        if (versionsList.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted">
                        Нет сохраненных версий
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = versionsList.map(version => `
            <tr data-version-id="${version.id}" class="version-row">
                <td><strong>#${version.id}</strong></td>
                <td>
                    <div>${formatDate(version.timestamp)}</div>
                    <small class="text-muted">${formatTime(version.timestamp)}</small>
                </td>
                <td>
                    <div class="fw-semibold">${escapeHtml(version.description)}</div>
                    <small class="text-muted">Хеш: ${version.hash.substring(0, 8)}...</small>
                </td>
                <td>
                    <span class="badge bg-info">${escapeHtml(version.author)}</span>
                </td>
                <td>
                    <span class="badge bg-${getChangeTypeColor(version.change_type)}">
                        ${escapeHtml(version.change_type)}
                    </span>
                </td>
                <td>
                    <span class="badge bg-secondary">${version.probes_count}</span>
                </td>
                <td>
                    <small>${formatFileSize(version.data_size)}</small>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary view-version-btn" 
                                data-version-id="${version.id}"
                                title="Просмотр">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-success restore-version-btn" 
                                data-version-id="${version.id}"
                                title="Восстановить">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="btn btn-outline-danger delete-version-btn" 
                                data-version-id="${version.id}"
                                title="Удалить">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        
        // Добавляем обработчики событий
        document.querySelectorAll('.view-version-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const versionId = this.getAttribute('data-version-id');
                viewVersion(versionId);
            });
        });
        
        document.querySelectorAll('.restore-version-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const versionId = this.getAttribute('data-version-id');
                if (confirm(`Восстановить версию #${versionId}? Текущие данные будут сохранены как резервная копия.`)) {
                    restoreVersion(versionId);
                }
            });
        });
        
        document.querySelectorAll('.delete-version-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const versionId = this.getAttribute('data-version-id');
                if (confirm(`Удалить версию #${versionId}? Это действие нельзя отменить.`)) {
                    deleteVersion(versionId);
                }
            });
        });
    }
    
    // Просмотр версии
    function viewVersion(versionId) {
        fetch(`/api/versions/${versionId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentSelectedVersion = data.version;
                    
                    // Заполняем модальное окно
                    document.getElementById('viewVersionTitle').textContent = `Версия #${data.version.id}`;
                    document.getElementById('viewVersionId').textContent = data.version.id;
                    document.getElementById('viewVersionDate').textContent = formatDateTime(data.version.timestamp);
                    document.getElementById('viewVersionAuthor').textContent = data.version.author;
                    document.getElementById('viewVersionType').textContent = data.version.change_type;
                    document.getElementById('viewVersionDescription').textContent = data.version.description;
                    
                    // JSON содержимое
                    document.getElementById('versionJsonContent').textContent = 
                        JSON.stringify(data.preview_data, null, 2);
                    
                    // Предпросмотр данных
                    renderVersionPreview(data.preview_data);
                    
                    // Показываем модальное окно
                    const modal = new bootstrap.Modal(document.getElementById('viewVersionModal'));
                    modal.show();
                }
            });
    }
    
    // Предпросмотр данных версии
    function renderVersionPreview(data) {
        const previewDiv = document.getElementById('versionPreviewContent');
        
        if (data.probes && data.probes.length > 0) {
            previewDiv.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Название</th>
                                <th>Статус</th>
                                <th>Дата</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.probes.slice(0, 5).map(probe => `
                                <tr>
                                    <td>${probe.id || ''}</td>
                                    <td>${escapeHtml(probe.name || '')}</td>
                                    <td><span class="badge bg-secondary">${probe.status || ''}</span></td>
                                    <td>${probe.date || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${data.probes.length > 5 ? 
                        `<p class="text-muted">... и еще ${data.probes.length - 5} проб</p>` : ''}
                </div>
            `;
        } else {
            previewDiv.innerHTML = '<p class="text-muted">Нет данных о пробах</p>';
        }
    }
    
    // Восстановление версии
    function restoreVersion(versionId) {
        fetch(`/api/versions/${versionId}/restore`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Версия успешно восстановлена!');
                loadVersions();
                
                // Редирект на главную страницу
                if (data.redirect) {
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 1000);
                }
            } else {
                alert('Ошибка восстановления: ' + data.error);
            }
        });
    }
    
    // Удаление версии
    function deleteVersion(versionId) {
        fetch(`/api/versions/${versionId}/delete`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Версия удалена');
                loadVersions();
            } else {
                alert('Ошибка удаления: ' + data.error);
            }
        });
    }
    
    // Создание версии
    document.getElementById('createVersionBtn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('createVersionModal'));
        modal.show();
    });
    
    document.getElementById('confirmCreateVersionBtn').addEventListener('click', function() {
        const description = document.getElementById('versionDescription').value;
        const author = document.getElementById('versionAuthor').value;
        
        fetch('/api/versions/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                description: description,
                author: author
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Версия создана успешно!');
                loadVersions();
                bootstrap.Modal.getInstance(document.getElementById('createVersionModal')).hide();
                document.getElementById('versionDescription').value = '';
            } else {
                alert(data.message || 'Ошибка создания версии');
            }
        });
    });
    
    // Сравнение версий
    function updateCompareSelects(versions) {
        const select1 = document.getElementById('compareVersion1');
        const select2 = document.getElementById('compareVersion2');
        
        select1.innerHTML = '<option value="">Выберите версию</option>';
        select2.innerHTML = '<option value="">Выберите версию</option>';
        
        versions.forEach(version => {
            const option = `<option value="${version.id}">#${version.id} - ${formatDate(version.timestamp)}</option>`;
            select1.innerHTML += option;
            select2.innerHTML += option;
        });
        
        // Устанавливаем последние две версии по умолчанию
        if (versions.length >= 2) {
            select1.value = versions[0].id;
            select2.value = versions[1].id;
        }
    }
    
    document.getElementById('doCompareBtn').addEventListener('click', function() {
        const v1 = document.getElementById('compareVersion1').value;
        const v2 = document.getElementById('compareVersion2').value;
        
        if (!v1 || !v2) {
            alert('Выберите обе версии для сравнения');
            return;
        }
        
        if (v1 === v2) {
            alert('Выберите разные версии для сравнения');
            return;
        }
        
        fetch(`/api/versions/compare?v1=${v1}&v2=${v2}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const result = data.comparison;
                    const resultDiv = document.getElementById('comparisonResult');
                    
                    let html = `
                        <div class="card">
                            <div class="card-body">
                                <h6>Результаты сравнения:</h6>
                                <ul>
                                    <li><strong>Изменение количества проб:</strong> ${result.probes_count_diff > 0 ? '+' : ''}${result.probes_count_diff}</li>
                                    <li><strong>Изменение размера данных:</strong> ${result.data_size_diff > 0 ? '+' : ''}${result.data_size_diff} байт</li>
                                    <li><strong>Содержимое одинаковое:</strong> ${result.is_same_hash ? 'Да' : 'Нет'}</li>
                                </ul>
                    `;
                    
                    if (result.detailed) {
                        html += `
                            <h6>Детали:</h6>
                            <ul>
                                <li><strong>Добавлено проб:</strong> ${result.detailed.added_probes.length}</li>
                                <li><strong>Удалено проб:</strong> ${result.detailed.removed_probes.length}</li>
                                <li><strong>Общих проб:</strong> ${result.detailed.common_probes.length}</li>
                            </ul>
                        `;
                    }
                    
                    html += `</div></div>`;
                    resultDiv.innerHTML = html;
                }
            });
    });
    
    // Вспомогательные функции
    function formatDateTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('ru-RU');
    }
    
    function formatDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleDateString('ru-RU');
    }
    
    function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }
    
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' Б';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' КБ';
        return (bytes / (1024 * 1024)).toFixed(1) + ' МБ';
    }
    
    function getChangeTypeColor(type) {
        const colors = {
            'manual': 'primary',
            'auto': 'secondary',
            'import': 'success',
            'restore': 'warning',
            'backup': 'info',
            'update': 'dark'
        };
        return colors[type] || 'light';
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showError(message) {
        // Реализация показа ошибки
        alert(message);
    }
    
    // Автообновление
    const autoRefreshCheckbox = document.getElementById('autoRefresh');
    let refreshInterval;
    
    autoRefreshCheckbox.addEventListener('change', function() {
        if (this.checked) {
            refreshInterval = setInterval(loadVersions, 30000); // Каждые 30 секунд
        } else {
            clearInterval(refreshInterval);
        }
    });
    
    // Загрузка данных при старте
    loadVersions();
    
    // Обработчики для кнопок в модальном окне просмотра
    document.getElementById('toggleJsonView').addEventListener('click', function() {
        const jsonView = document.getElementById('versionJsonView');
        jsonView.style.display = jsonView.style.display === 'none' ? 'block' : 'none';
    });
    
    document.getElementById('restoreVersionBtn').addEventListener('click', function() {
        if (currentSelectedVersion) {
            if (confirm(`Восстановить версию #${currentSelectedVersion.id}?`)) {
                restoreVersion(currentSelectedVersion.id);
                bootstrap.Modal.getInstance(document.getElementById('viewVersionModal')).hide();
            }
        }
    });
    
    document.getElementById('exportVersionBtn').addEventListener('click', function() {
        if (currentSelectedVersion) {
            window.open(`/api/versions/${currentSelectedVersion.id}/export`, '_blank');
        }
    });
});
</script>
{% endblock %}